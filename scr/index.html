<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>F1 - Race Chart</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <center>
        <select id="yearSelect">
            <option value="">Selecione um ano</option>
        </select>

        <select id="raceSelect" disabled>
            <option value="">Selecione uma corrida</option>
        </select>

        <button id="playPause">‚ñ∂Ô∏è Play</button>
        <input type="range" id="lapSlider" min="0" max="0" value="0" step="1" disabled>
        <span id="lapDisplay">Volta 1</span>
    </center>

    <br>
    <center>
        <svg width="1500" height="860">
            <rect width="100%" height="100%" x="0" y="0" style="fill:#22b14c;" />
            <rect width="1480" height="840" x="10" y="10" style="fill:#ffffff;" />
            <rect width="1460" height="820" x="20" y="20" style="fill:#383737;" />
            <g id="grid"></g>
        </svg>
    </center>
    

    <div id="tooltip" style="position: absolute; background-color: white; border: 1px solid #ccc; padding: 10px; pointer-events: none; opacity: 0; border-radius: 8px;"></div>


    <script>
        const grid = document.getElementById('grid');
        // Definindo as posi√ß√µes das colunas (ordem decrescente para manter o padr√£o da primeira linha)
        const cols = [1360, 1380, 1400, 1420];
        // Calcula o n√∫mero de linhas: de y = 20 at√© y = 860, de 20 em 20
        const numRows = Math.floor((860 - 20) / 20) + 1;
        
        for (let row = 0; row < numRows - 2; row++) {
            const y = 20 + row * 20;
            for (let i = 0; i < cols.length; i++) {
            const x = cols[cols.length - 1 - i];
            let fill;
            if (row % 2 === 0) {
                fill = (i % 2 === 0) ? "#ffffff" : "#000000";
            } else {
                fill = (i % 2 === 0) ? "#000000" : "#ffffff";
            }
            const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rect.setAttribute("width", "20");
            rect.setAttribute("height", "20");
            rect.setAttribute("x", x);
            rect.setAttribute("y", y);
            rect.setAttribute("style", "fill:" + fill + ";");
            grid.appendChild(rect);
            }
        }
        
        const svg = d3.select("svg");
        const width = +svg.attr("width");
        const height = +svg.attr("height");
        const margin = { top: 20, right: 200, bottom: 20, left: 25 };
        const chartWidth = width - margin.left - margin.right;
        const chartHeight = height - margin.top - margin.bottom;
        const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

        // Fixando o tamanho da corrida em 300
        const x = d3.scaleLinear().range([0, chartWidth]).domain([0, 300]);
        const y = d3.scaleBand().range([0, chartHeight]).padding(0.1);

        // Tamanho do sprite
        const spriteWidth = 72;
        const spriteHeight = 45;

        // Carregando os elementos da p√°gina
        const yearSelect = document.getElementById("yearSelect");
        const raceSelect = document.getElementById("raceSelect");
        const playPauseBtn = document.getElementById("playPause");
        const lapSlider = document.getElementById("lapSlider");
        const lapDisplay = document.getElementById("lapDisplay");

        let currentLap = 0;
        let intervalId = null;
        let isPlaying = false;
        const numberOfLaps = 20;
        let laps = [];

        // Cores de cada equipe
        const cores_equipes = {
        red_bull: "#181740",
        mercedez: "#41F2D2",
        ferrari: "#D90707",
        alpine: "#0090FF",
        hass: "#BF0A2B",
        aston_martin: "#048C5A",
        mclaren: "#F28D35",
        sauber: "#05A61D",
        willians: "#113A8C",
        toro_roso: "#F2F2F2"
        };

        // Op√ß√µes de anos e corridas
        const mockRacesByYear = {
        "2024": [
            "Bahrain GP (üáßüá≠)", "Saudi Arabian GP (üá∏üá¶)", "Australian GP (üá¶üá∫)", "Japanese GP (üáØüáµ)", "Chinese GP (üá®üá≥)",
            "Miami GP (üá∫üá∏)", "Emilia Romagna GP (üáÆüáπ)", "Monaco GP (üá≤üá®)", "Canadian GP (üá®üá¶)", "Spanish GP (üá™üá∏)",
            "Austrian GP (üá¶üáπ)", "British GP (üá¨üáß)", "Hungarian GP (üá≠üá∫)", "Belgian GP (üáßüá™)", "Dutch GP (üá≥üá±)",
            "Italian GP (üáÆüáπ)", "Azerbaijan GP (üá¶üáø)", "Singapore GP (üá∏üá¨)", "United States GP (üá∫üá∏)",
            "Mexico City GP (üá≤üáΩ)", "S√£o Paulo GP (üáßüá∑)", "Las Vegas GP (üá∫üá∏)", "Qatar GP (üá∂üá¶)", "Abu Dhabi GP (üá¶üá™)"
        ],
        "2023": [
            "Bahrain GP (üáßüá≠)", "Saudi Arabian GP (üá∏üá¶)", "Australian GP (üá¶üá∫)", "Azerbaijan GP (üá¶üáø)", "Miami GP (üá∫üá∏)",
            "Monaco GP (üá≤üá®)", "Spanish GP (üá™üá∏)", "Canadian GP (üá®üá¶)", "Austrian GP (üá¶üáπ)", "British GP (üá¨üáß)",
            "Hungarian GP (üá≠üá∫)", "Belgian GP (üáßüá™)", "Dutch GP (üá≥üá±)", "Italian GP (üáÆüáπ)", "Singapore GP (üá∏üá¨)",
            "Japanese GP (üáØüáµ)", "Qatar GP (üá∂üá¶)", "United States GP (üá∫üá∏)", "Mexico City GP (üá≤üáΩ)",
            "S√£o Paulo GP (üáßüá∑)", "Las Vegas GP (üá∫üá∏)", "Abu Dhabi GP (üá¶üá™)"
        ],
        "2022": [
            "Bahrain GP (üáßüá≠)", "Saudi Arabian GP (üá∏üá¶)", "Australian GP (üá¶üá∫)", "Emilia Romagna GP (üáÆüáπ)", "Miami GP (üá∫üá∏)",
            "Spanish GP (üá™üá∏)", "Monaco GP (üá≤üá®)", "Azerbaijan GP (üá¶üáø)", "Canadian GP (üá®üá¶)", "British GP (üá¨üáß)",
            "Austrian GP (üá¶üáπ)", "French GP (üá´üá∑)", "Hungarian GP (üá≠üá∫)", "Belgian GP (üáßüá™)", "Dutch GP (üá≥üá±)",
            "Italian GP (üáÆüáπ)", "Singapore GP (üá∏üá¨)", "Japanese GP (üáØüáµ)", "United States GP (üá∫üá∏)",
            "Mexico City GP (üá≤üáΩ)", "S√£o Paulo GP (üáßüá∑)", "Abu Dhabi GP (üá¶üá™)"
        ],
        "2021": [
            "Bahrain GP (üáßüá≠)", "Emilia Romagna GP (üáÆüáπ)", "Portuguese GP (üáµüáπ)", "Spanish GP (üá™üá∏)", "Monaco GP (üá≤üá®)",
            "Azerbaijan GP (üá¶üáø)", "French GP (üá´üá∑)", "Styrian GP (üá¶üáπ)", "Austrian GP (üá¶üáπ)", "British GP (üá¨üáß)",
            "Hungarian GP (üá≠üá∫)", "Belgian GP (üáßüá™)", "Dutch GP (üá≥üá±)", "Italian GP (üáÆüáπ)", "Russian GP (üá∑üá∫)",
            "Turkish GP (üáπüá∑)", "United States GP (üá∫üá∏)", "Mexico City GP (üá≤üáΩ)", "S√£o Paulo GP (üáßüá∑)",
            "Qatar GP (üá∂üá¶)", "Saudi Arabian GP (üá∏üá¶)", "Abu Dhabi GP (üá¶üá™)"
        ],
        "2020": [
            "Austrian GP (üá¶üáπ)", "Styrian GP (üá¶üáπ)", "Hungarian GP (üá≠üá∫)", "British GP (üá¨üáß)", "70th Anniversary GP (üá¨üáß)",
            "Spanish GP (üá™üá∏)", "Belgian GP (üáßüá™)", "Italian GP (üáÆüáπ)", "Tuscan GP (üáÆüáπ)", "Russian GP (üá∑üá∫)",
            "Eifel GP (üá©üá™)", "Portuguese GP (üáµüáπ)", "Emilia Romagna GP (üáÆüáπ)", "Turkish GP (üáπüá∑)",
            "Bahrain GP (üáßüá≠)", "Sakhir GP (üáßüá≠)", "Abu Dhabi GP (üá¶üá™)"
        ]
        };



        const initialDrivers = [
        { name: "Max Verstappen", equipe: "red_bull", equipe_real: "Red Bull (üá¶üáπ)", idade: 25, nacionalidade: "üá≥üá±", pneus: "Macios (‚ö™)", posicao_grid: 1, volta_mais_rapida: "1:18.235" },
        { name: "Yuki Tsunoda", equipe: "red_bull", equipe_real: "Red Bull (üá¶üáπ)", idade: 23, nacionalidade: "üáØüáµ", pneus: "M√©dios (üü°)", posicao_grid: 2, volta_mais_rapida: "1:20.412" },
        { name: "Lewis Hamilton", equipe: "ferrari", equipe_real: "Ferrari (üáÆüáπ)", idade: 39, nacionalidade: "üá¨üáß", pneus: "Duros (üî¥)", posicao_grid: 3, volta_mais_rapida: "1:19.832" },
        { name: "Charles Leclerc", equipe: "ferrari", equipe_real: "Ferrari (üáÆüáπ)", idade: 26, nacionalidade: "üá≤üá®", pneus: "Macios (‚ö™)", posicao_grid: 4, volta_mais_rapida: "1:19.574" },
        { name: "Lando Norris", equipe: "mclaren", equipe_real: "McLaren (üá¨üáß)", idade: 24, nacionalidade: "üá¨üáß", pneus: "M√©dios (üü°)", posicao_grid: 5, volta_mais_rapida: "1:20.001" },
        { name: "Oscar Piastri", equipe: "mclaren", equipe_real: "McLaren (üá¨üáß)", idade: 23, nacionalidade: "üá¶üá∫", pneus: "Duros (üî¥)", posicao_grid: 6, volta_mais_rapida: "1:21.033" },
        { name: "Pierre Gasly", equipe: "alpine", equipe_real: "Alpine (üá´üá∑)", idade: 28, nacionalidade: "üá´üá∑", pneus: "Macios (‚ö™)", posicao_grid: 7, volta_mais_rapida: "1:20.546" },
        { name: "Jack Doohan", equipe: "alpine", equipe_real: "Alpine (üá´üá∑)", idade: 21, nacionalidade: "üá¶üá∫", pneus: "M√©dios (üü°)", posicao_grid: 8, volta_mais_rapida: "1:21.928" },
        { name: "Fernando Alonso", equipe: "aston_martin", equipe_real: "Aston Martin (üá¨üáß)", idade: 43, nacionalidade: "üá™üá∏", pneus: "Duros (üî¥)", posicao_grid: 9, volta_mais_rapida: "1:20.238" },
        { name: "Lance Stroll", equipe: "aston_martin", equipe_real: "Aston Martin (üá¨üáß)", idade: 26, nacionalidade: "üá®üá¶", pneus: "Macios (‚ö™)", posicao_grid: 10, volta_mais_rapida: "1:21.411" },
        { name: "Alexander Albon", equipe: "willians", equipe_real: "Williams (üá¨üáß)", idade: 28, nacionalidade: "üáπüá≠", pneus: "M√©dios (üü°)", posicao_grid: 11, volta_mais_rapida: "1:21.015" },
        { name: "Carlos Sainz", equipe: "willians", equipe_real: "Williams (üá¨üáß)", idade: 30, nacionalidade: "üá™üá∏", pneus: "Duros (üî¥)", posicao_grid: 12, volta_mais_rapida: "1:20.372" },
        { name: "Isack Hadjar", equipe: "toro_roso", equipe_real: "Visa Cash App RB (üáÆüáπ)", idade: 20, nacionalidade: "üá´üá∑", pneus: "Macios (‚ö™)", posicao_grid: 13, volta_mais_rapida: "1:22.007" },
        { name: "Liam Lawson", equipe: "toro_roso", equipe_real: "Visa Cash App RB (üáÆüáπ)", idade: 23, nacionalidade: "üá≥üáø", pneus: "M√©dios (üü°)", posicao_grid: 14, volta_mais_rapida: "1:21.842" },
        { name: "Kimi Antonelli", equipe: "mercedez", equipe_real: "Mercedes (üá©üá™)", idade: 18, nacionalidade: "üáÆüáπ", pneus: "Duros (üî¥)", posicao_grid: 15, volta_mais_rapida: "1:23.001" },
        { name: "George Russell", equipe: "mercedez", equipe_real: "Mercedes (üá©üá™)", idade: 26, nacionalidade: "üá¨üáß", pneus: "Macios (‚ö™)", posicao_grid: 16, volta_mais_rapida: "1:19.617" },
        { name: "Oliver Bearman", equipe: "hass", equipe_real: "Haas (üá∫üá∏)", idade: 19, nacionalidade: "üá¨üáß", pneus: "M√©dios (üü°)", posicao_grid: 17, volta_mais_rapida: "1:22.366" },
        { name: "Esteban Ocon", equipe: "hass", equipe_real: "Haas (üá∫üá∏)", idade: 28, nacionalidade: "üá´üá∑", pneus: "Duros (üî¥)", posicao_grid: 18, volta_mais_rapida: "1:21.774" },
        { name: "Nico H√ºlkenberg", equipe: "sauber", equipe_real: "Sauber (üá®üá≠)", idade: 37, nacionalidade: "üá©üá™", pneus: "Macios (‚ö™)", posicao_grid: 19, volta_mais_rapida: "1:23.377" },
        { name: "Gabriel Bortoleto", equipe: "sauber", equipe_real: "Sauber (üá®üá≠)", idade: 20, nacionalidade: "üáßüá∑", pneus: "M√©dios (üü°)", posicao_grid: 20, volta_mais_rapida: "1:18.983" }
        ];






        // Fun√ß√£o que gera dados falsos
        function generateMockLaps() {
        const laps = [];
        // Volta 0: score inicial 0
        const drivers = initialDrivers.map(driver => ({ ...driver, score: 0 }));
        laps.push(JSON.parse(JSON.stringify(drivers)));

        for (let lap = 1; lap < numberOfLaps; lap++) {
            const previousLap = JSON.parse(JSON.stringify(laps[lap - 1]));
            const newLap = previousLap.map(driver => {
            const noise = d3.randomNormal(0, Math.sqrt(5))();
            const increment = 15 + noise;
            return {
                ...driver,
                score: Math.max(0, driver.score + increment)
            };
            });
            laps.push(newLap);
        }
        return laps;
        }

        laps = generateMockLaps();

        // Insere anos no select
        const availableYears = ["2024", "2023", "2022", "2021", "2020"];
        availableYears.forEach(year => {
        const option = document.createElement("option");
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
        });

        // Insere corridas no select
        yearSelect.addEventListener("change", () => {
        const selectedYear = yearSelect.value;
        raceSelect.innerHTML = '<option value="">Selecione uma corrida</option>';
        raceSelect.disabled = true;

        if (selectedYear && mockRacesByYear[selectedYear]) {
            mockRacesByYear[selectedYear].forEach(race => {
            const opt = document.createElement("option");
            opt.value = race;
            opt.textContent = race;
            raceSelect.appendChild(opt);
            });
            raceSelect.disabled = false;
        }
        stopPlayback();
        });

        // Renderiza a volta
        raceSelect.addEventListener("change", () => {
        const raceChosen = raceSelect.value;
        if (raceChosen) {
            currentLap = 0;
            renderLap(laps[currentLap], currentLap);
            updateUI();
        }
        stopPlayback();
        });

        playPauseBtn.addEventListener("click", () => {
        if (isPlaying) {
            stopPlayback();
        } else {
            isPlaying = true;
            playPauseBtn.textContent = "‚è∏Ô∏è Pause";
            intervalId = setInterval(() => {
            if (currentLap < laps.length - 1) {
                currentLap++;
                lapSlider.value = currentLap;
                renderLap(laps[currentLap], currentLap);
                updateUI();
            } else {
                stopPlayback();
            }
            }, 1500);
        }
        });

        lapSlider.addEventListener("input", () => {
        currentLap = parseInt(lapSlider.value);
        renderLap(laps[currentLap], currentLap);
        updateUI();
        stopPlayback();
        });

        function stopPlayback() {
        clearInterval(intervalId);
        isPlaying = false;
        playPauseBtn.textContent = "‚ñ∂Ô∏è Play";
        }

        function updateUI() {
        lapSlider.max = laps.length - 1;
        lapSlider.disabled = false;
        lapSlider.value = currentLap;
        lapDisplay.textContent = `Volta ${currentLap + 1}`;
        }

        // Renderiza a volta usando o score acumulado (eixo x fixo de 0 a 300)
        function renderLap(data, lapNum) {
            // Ordena os pilotos pelo score (maior primeiro)
            const sorted = [...data].sort((a, b) => b.score - a.score);
            y.domain(sorted.map(d => d.name));

            // Atualiza as barras
            const bars = g.selectAll(".bar").data(sorted, d => d.name);
            bars.enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", 0)
                .attr("height", y.bandwidth())
                .attr("y", d => y(d.name))
                .attr("width", d => x(d.score))
                .attr("fill", d => cores_equipes[d.equipe] || "#ccc")
                .attr("fill-opacity", 1)  // garante opacidade total
                .merge(bars)
                .transition().duration(600)
                .attr("y", d => y(d.name))
                .attr("width", d => x(d.score))
                .attr("fill-opacity",0.8 ); // mant√©m opacidade total na transi√ß√£o
            bars.exit().remove();


            const labels = g.selectAll(".label").data(sorted, d => d.name);
            labels.enter()
                .append("text")
                .attr("class", "label")
                .attr("fill", d => {
                    const estimatedTextWidth = d.name.length * 9;
                    const margemErro = 15;
                    return x(d.score) > estimatedTextWidth + margemErro ? "white" : "black";
                })
                .attr("x", d => {
                    const estimatedTextWidth = d.name.length * 9;
                    const margemErro = 15;
                    return x(d.score) > estimatedTextWidth + margemErro
                        ? x(d.score) - estimatedTextWidth - 10  
                        : x(d.score) + spriteWidth + 10;         
                })
                .attr("y", d => y(d.name) + y.bandwidth() / 2 + 5)
                .text(d => d.name)
                .merge(labels)
                .transition().duration(600)
                .attr("fill", d => {
                    const estimatedTextWidth = d.name.length * 9;
                    const margemErro = 15;
                    return x(d.score) > estimatedTextWidth + margemErro ? "white" : "black";
                })
                .attr("x", d => {
                    const estimatedTextWidth = d.name.length * 9;
                    const margemErro = 15;
                    return x(d.score) > estimatedTextWidth + margemErro
                        ? x(d.score) - estimatedTextWidth - 10
                        : x(d.score) + spriteWidth + 10;
                })
                .attr("y", d => y(d.name) + y.bandwidth() / 2 + 5);
            labels.exit().remove();


            const tooltip = d3.select("#tooltip");

            const sprites = g.selectAll("image.sprite").data(sorted, d => d.name);
            sprites.enter()
                .append("image")
                .attr("class", "sprite")
                .attr("xlink:href", d => `../sprites/${d.equipe}.png`)
                .attr("width", spriteWidth)
                .attr("height", spriteHeight)
                .on("mouseover", function(event, d) {
                    tooltip
                        .style("opacity", 1)
                        .html(`
                            <div style="display: flex; align-items: center; background-color: white; border-radius: 5px; padding: 2px;">
                                <img src="../sprites/${d.name.replace(/ /g, '_').toLowerCase()}.png" alt="${d.name}" style="width:130px; margin-right:10px;">
                                <div>
                                    <strong>${d.name}</strong><br>
                                    Idade: ${d.idade} anos<br>
                                    Equipe: ${d.equipe_real}<br>
                                    Nacionalidade: ${d.nacionalidade}<br>
                                    Pneus: ${d.pneus}<br>
                                    Largada: ${d.posicao_grid}¬∫<br>
                                    VMR: ${d.volta_mais_rapida} min<br>
                                </div>
                            </div>
                        `);
                })
                .on("mousemove", function(event) {
                    tooltip
                        .style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                })
                .merge(sprites)
                .transition().duration(600)
                .attr("transform", d => {
                    const posX = x(d.score) + 5;
                    const posY = y(d.name) + (y.bandwidth() - spriteHeight) / 2;
                    return `translate(${posX + spriteWidth/2},${posY + spriteHeight/2}) rotate(90) translate(${-spriteWidth/2},${-spriteHeight/2})`;
                });

            sprites.exit().remove();

            d3.select("h2").text(`F1 Bar Chart Race - Volta ${lapNum + 1}`);
        }
    </script>
</body>
</html>

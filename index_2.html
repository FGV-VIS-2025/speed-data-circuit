<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>F1 Bar Chart Race</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 30px;
    }
    .bar {
      fill-opacity: 0.7;
    }
    .label {
      font-size: 14px;
      fill: #111;
    }
    select, button, input[type=range] {
      margin-right: 10px;
      padding: 5px;
      font-size: 14px;
    }
    input[type=range] {
      width: 200px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <h2>F1 Bar Chart Race - 20 Pilotos</h2>

  <label for="yearSelect">Ano:</label>
  <select id="yearSelect">
    <option value="">Selecione um ano</option>
  </select>

  <label for="raceSelect">Corrida:</label>
  <select id="raceSelect" disabled>
    <option value="">Selecione uma corrida</option>
  </select>

  <br><br>
  <button id="playPause">▶️ Play</button>
  <input type="range" id="lapSlider" min="0" max="0" value="0" step="1" disabled>
  <span id="lapDisplay">Volta 1</span>

  <svg width="1200" height="800"></svg>

  <script>
    const svg = d3.select("svg");
    const width = +svg.attr("width");
    const height = +svg.attr("height");
    const margin = { top: 20, right: 200, bottom: 20, left: 20 };
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;
    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

    // Escala x fixa de 0 a 300
    const x = d3.scaleLinear().range([0, chartWidth]).domain([0, 300]);
    const y = d3.scaleBand().range([0, chartHeight]).padding(0.1);

    const spriteWidth = 64;
    const spriteHeight = 40;

    const yearSelect = document.getElementById("yearSelect");
    const raceSelect = document.getElementById("raceSelect");
    const playPauseBtn = document.getElementById("playPause");
    const lapSlider = document.getElementById("lapSlider");
    const lapDisplay = document.getElementById("lapDisplay");

    let currentLap = 0;
    let intervalId = null;
    let isPlaying = false;

    const cores_equipes = {
      red_bull: "#181740",
      mercedez: "#3D3E40",
      ferrari: "#D90707",
      alpine: "#0090FF",
      hass: "#BF0A2B",
      aston_martin: "#048C5A",
      mclaren: "#F28D35",
      sauber: "#05A61D",
      willians: "#113A8C",
      toro_roso: "#F2F2F2"
    };

    const mockRacesByYear = {
      "2022": ["Bahrain GP", "Monaco GP", "Brazil GP"],
      "2023": ["Bahrain GP", "Miami GP", "Japan GP"],
      "2024": ["Australia GP", "Canada GP", "Italy GP"]
    };

    // Array inicial com os 20 pilotos e suas equipes (score inicia em 0)
    const initialDrivers = [
      { name: "Max Verstappen", equipe: "red_bull" },
      { name: "Lewis Hamilton", equipe: "mercedez" },
      { name: "Charles Leclerc", equipe: "ferrari" },
      { name: "Lando Norris", equipe: "mclaren" },
      { name: "Sergio Perez", equipe: "red_bull" },
      { name: "Carlos Sainz", equipe: "ferrari" },
      { name: "Fernando Alonso", equipe: "alpine" },
      { name: "Sebastian Vettel", equipe: "aston_martin" },
      { name: "Daniel Ricciardo", equipe: "mclaren" },
      { name: "Esteban Ocon", equipe: "alpine" },
      { name: "Lance Stroll", equipe: "aston_martin" },
      { name: "Pierre Gasly", equipe: "willians" },
      { name: "Yuki Tsunoda", equipe: "toro_roso" },
      { name: "Valtteri Bottas", equipe: "mercedez" },
      { name: "Kevin Magnussen", equipe: "hass" },
      { name: "Mick Schumacher", equipe: "hass" },
      { name: "Nicholas Latifi", equipe: "willians" },
      { name: "Alexander Albon", equipe: "toro_roso" },
      { name: "Robert Kubica", equipe: "sauber" },
      { name: "Guanyu Zhou", equipe: "sauber" }
    ];

    const numberOfLaps = 20;
    let laps = [];

    // Gera os incrementos de cada volta (cada piloto ganha 10 + ruído gaussiano)
    function generateMockLaps() {
      const laps = [];
      // Volta 0: score inicial 0
      const drivers = initialDrivers.map(driver => ({ ...driver, score: 0 }));
      laps.push(JSON.parse(JSON.stringify(drivers)));

      for (let lap = 1; lap < numberOfLaps; lap++) {
        const previousLap = JSON.parse(JSON.stringify(laps[lap - 1]));
        const newLap = previousLap.map(driver => {
          const noise = d3.randomNormal(0, Math.sqrt(5))();
          const increment = 13 + noise;
          return {
            ...driver,
            score: Math.max(0, driver.score + increment)
          };
        });
        laps.push(newLap);
      }
      return laps;
    }

    laps = generateMockLaps();

    // Popula o select de anos
    const availableYears = ["2022", "2023", "2024"];
    availableYears.forEach(year => {
      const option = document.createElement("option");
      option.value = year;
      option.textContent = year;
      yearSelect.appendChild(option);
    });

    yearSelect.addEventListener("change", () => {
      const selectedYear = yearSelect.value;
      raceSelect.innerHTML = '<option value="">Selecione uma corrida</option>';
      raceSelect.disabled = true;

      if (selectedYear && mockRacesByYear[selectedYear]) {
        mockRacesByYear[selectedYear].forEach(race => {
          const opt = document.createElement("option");
          opt.value = race;
          opt.textContent = race;
          raceSelect.appendChild(opt);
        });
        raceSelect.disabled = false;
      }
      stopPlayback();
    });

    raceSelect.addEventListener("change", () => {
      const raceChosen = raceSelect.value;
      if (raceChosen) {
        currentLap = 0;
        renderLap(laps[currentLap], currentLap);
        updateUI();
      }
      stopPlayback();
    });

    playPauseBtn.addEventListener("click", () => {
      if (isPlaying) {
        stopPlayback();
      } else {
        isPlaying = true;
        playPauseBtn.textContent = "⏸️ Pause";
        intervalId = setInterval(() => {
          if (currentLap < laps.length - 1) {
            currentLap++;
            lapSlider.value = currentLap;
            renderLap(laps[currentLap], currentLap);
            updateUI();
          } else {
            stopPlayback();
          }
        }, 1500);
      }
    });

    lapSlider.addEventListener("input", () => {
      currentLap = parseInt(lapSlider.value);
      renderLap(laps[currentLap], currentLap);
      updateUI();
      stopPlayback();
    });

    function stopPlayback() {
      clearInterval(intervalId);
      isPlaying = false;
      playPauseBtn.textContent = "▶️ Play";
    }

    function updateUI() {
      lapSlider.max = laps.length - 1;
      lapSlider.disabled = false;
      lapSlider.value = currentLap;
      lapDisplay.textContent = `Volta ${currentLap + 1}`;
    }

    // Define a cor de fundo do SVG
    d3.select("svg").style("background-color", "#A39B9B");

    // Renderiza a volta usando o score acumulado (o eixo x é fixo de 0 a 300)
    function renderLap(data, lapNum) {
      // Ordena os pilotos pelo score acumulado (maior primeiro)
      const sorted = [...data].sort((a, b) => b.score - a.score);
      y.domain(sorted.map(d => d.name));

      // Atualiza as barras
      const bars = g.selectAll(".bar").data(sorted, d => d.name);
      bars.enter()
        .append("rect")
        .attr("class", "bar")
        .attr("x", 0)
        .attr("height", y.bandwidth())
        .attr("y", d => y(d.name))
        .attr("width", d => x(d.score))
        .attr("fill", d => cores_equipes[d.equipe] || "#ccc")
        .merge(bars)
        .transition().duration(600)
        .attr("y", d => y(d.name))
        .attr("width", d => x(d.score));
      bars.exit().remove();

      // Atualiza os labels
      const labels = g.selectAll(".label").data(sorted, d => d.name);
      labels.enter()
        .append("text")
        .attr("class", "label")
        .attr("x", d => x(d.score) + spriteWidth + 10)
        .attr("y", d => y(d.name) + y.bandwidth() / 2 + 5)
        .text(d => d.name)
        .merge(labels)
        .transition().duration(600)
        .attr("x", d => x(d.score) + spriteWidth + 10)
        .attr("y", d => y(d.name) + y.bandwidth() / 2 + 5);
      labels.exit().remove();

      // Atualiza os sprites
      const sprites = g.selectAll("image.sprite").data(sorted, d => d.name);
      sprites.enter()
        .append("image")
        .attr("class", "sprite")
        .attr("xlink:href", d => `sprites/${d.equipe}.png`)
        .attr("width", spriteWidth)
        .attr("height", spriteHeight)
        .merge(sprites)
        .transition().duration(600)
        .attr("transform", d => {
          const posX = x(d.score) + 5;
          const posY = y(d.name) + (y.bandwidth() - spriteHeight) / 2;
          return `translate(${posX + spriteWidth/2},${posY + spriteHeight/2}) rotate(90) translate(${-spriteWidth/2},${-spriteHeight/2})`;
        });
      sprites.exit().remove();

      d3.select("h2").text(`F1 Bar Chart Race - Volta ${lapNum + 1}`);
    }
  </script>
</body>
</html>

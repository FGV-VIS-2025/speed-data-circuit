<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>F1 Bar Chart Race</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 30px;
    }
    .bar {
      fill-opacity: 0.7;
    }
    .label {
      font-size: 14px;
      fill: #111;
    }
    select, button, input[type=range] {
      margin-right: 10px;
      padding: 5px;
      font-size: 14px;
    }
    input[type=range] {
      width: 200px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <h2>F1 Bar Chart Race - Top 10 Pilotos</h2>

  <label for="yearSelect">Ano:</label>
  <select id="yearSelect">
    <option value="">Selecione um ano</option>
  </select>

  <label for="raceSelect">Corrida:</label>
  <select id="raceSelect" disabled>
    <option value="">Selecione uma corrida</option>
  </select>

  <br><br>
  <button id="playPause">▶️ Play</button>
  <input type="range" id="lapSlider" min="0" max="0" value="0" step="1" disabled>
  <span id="lapDisplay">Volta 1</span>

  <svg width="1200" height="400"></svg>

  <script>
    const svg = d3.select("svg");
    const width = +svg.attr("width");
    const height = +svg.attr("height");
    const margin = { top: 40, right: 20, bottom: 40, left: 100 };
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;
    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
    const x = d3.scaleLinear().range([0, chartWidth]);
    const y = d3.scaleBand().range([0, chartHeight]).padding(0.1);

    // Tamanho do sprite
    const spriteWidth = 30;
    const spriteHeight = 30;
    
    const yearSelect = document.getElementById("yearSelect");
    const raceSelect = document.getElementById("raceSelect");
    const playPauseBtn = document.getElementById("playPause");
    const lapSlider = document.getElementById("lapSlider");
    const lapDisplay = document.getElementById("lapDisplay");

    let currentLap = 0;
    let intervalId = null;
    let isPlaying = false;

    const mockRacesByYear = {
      "2022": ["Bahrain GP", "Monaco GP", "Brazil GP"],
      "2023": ["Bahrain GP", "Miami GP", "Japan GP"],
      "2024": ["Australia GP", "Canada GP", "Italy GP"]
    };

    const mockLaps = [
      [
        { name: "Verstappen", position: 1, equipe: "red_bull"},
        { name: "Hamilton", position: 2, equipe: "mercedez"},
        { name: "Leclerc", position: 3, equipe:"ferrari" },
        { name: "Perez", position: 4, equipe: "alpine" },
        { name: "Sainz", position: 5, equipe: "hass"},
        { name: "Russell", position: 6, equipe: "aston_martin"},
        { name: "Norris", position: 7, equipe: "mclaren"},
        { name: "Alonso", position: 8, equipe: "sauber"},
        { name: "Gasly", position: 9, equipe: "willians"},
        { name: "Ocon", position: 10, equipe: "toro_roso"},
      ],
      [
        { name: "Verstappen", position: 1, equipe: "red_bull" },
        { name: "Leclerc", position: 2, equipe:"ferrari" },
        { name: "Hamilton", position: 3, equipe: "mercedez" },
        { name: "Sainz", position: 4, equipe: "hass" },
        { name: "Perez", position: 5, equipe: "alpine" },
        { name: "Russell", position: 6, equipe: "aston_martin" },
        { name: "Norris", position: 7, equipe: "mclaren" },
        { name: "Gasly", position: 8, equipe: "willians" },
        { name: "Alonso", position: 9, equipe: "sauber" },
        { name: "Ocon", position: 10, equipe: "toro_roso" },
      ],
      [
        { name: "Leclerc", position: 1, equipe:"ferrari" },
        { name: "Verstappen", position: 2, equipe: "red_bull" },
        { name: "Sainz", position: 3, equipe: "hass" },
        { name: "Hamilton", position: 4, equipe: "mercedez" },
        { name: "Russell", position: 5, equipe: "aston_martin" },
        { name: "Perez", position: 6, equipe: "alpine" },
        { name: "Alonso", position: 7, equipe: "sauber" },
        { name: "Norris", position: 8, equipe: "mclaren" },
        { name: "Gasly", position: 9, equipe: "willians" },
        { name: "Ocon", position: 10, equipe: "toro_roso" },
      ]
    ];

    let laps = mockLaps;

    const availableYears = ["2022", "2023", "2024"];
    availableYears.forEach(year => {
      const option = document.createElement("option");
      option.value = year;
      option.textContent = year;
      yearSelect.appendChild(option);
    });

    yearSelect.addEventListener("change", () => {
      const selectedYear = yearSelect.value;
      raceSelect.innerHTML = '<option value="">Selecione uma corrida</option>';
      raceSelect.disabled = true;

      if (selectedYear && mockRacesByYear[selectedYear]) {
        mockRacesByYear[selectedYear].forEach(race => {
          const opt = document.createElement("option");
          opt.value = race;
          opt.textContent = race;
          raceSelect.appendChild(opt);
        });
        raceSelect.disabled = false;
      }

      stopPlayback();
    });

    raceSelect.addEventListener("change", () => {
      const raceChosen = raceSelect.value;
      if (raceChosen) {
        currentLap = 0;
        renderLap(laps[currentLap], currentLap);
        updateUI();
      }
      stopPlayback();
    });

    playPauseBtn.addEventListener("click", () => {
      if (isPlaying) {
        stopPlayback();
      } else {
        isPlaying = true;
        playPauseBtn.textContent = "⏸️ Pause";
        intervalId = setInterval(() => {
          if (currentLap < laps.length - 1) {
            currentLap++;
            lapSlider.value = currentLap;
            renderLap(laps[currentLap], currentLap);
            updateUI();
          } else {
            stopPlayback();
          }
        }, 1500);
      }
    });

    lapSlider.addEventListener("input", () => {
      currentLap = parseInt(lapSlider.value);
      renderLap(laps[currentLap], currentLap);
      updateUI();
      stopPlayback();
    });

    function stopPlayback() {
      clearInterval(intervalId);
      isPlaying = false;
      playPauseBtn.textContent = "▶️ Play";
    }

    function updateUI() {
      lapSlider.max = laps.length - 1;
      lapSlider.disabled = false;
      lapSlider.value = currentLap;
      lapDisplay.textContent = `Volta ${currentLap + 1}`;
    }

    function renderLap(data, lapNum) {
      const sorted = [...data].sort((a, b) => a.position - b.position);
      x.domain([0, 11]);
      y.domain(sorted.map(d => d.name));

      // Atualiza as barras
      const bars = g.selectAll(".bar").data(sorted, d => d.name);
      bars.enter()
        .append("rect")
        .attr("class", "bar")
        .attr("x", 0)
        .attr("height", y.bandwidth())
        .attr("y", d => y(d.name))
        .attr("width", d => x(11 - d.position))
        .attr("fill", (d, i) => d3.schemeTableau10[i % 10])
        .merge(bars)
        .transition().duration(600)
        .attr("y", d => y(d.name))
        .attr("width", d => x(11 - d.position));
      bars.exit().remove();

      // Atualiza os labels
      const labels = g.selectAll(".label").data(sorted, d => d.name);
      labels.enter()
        .append("text")
        .attr("class", "label")
        .attr("x", d => x(11 - d.position) + spriteWidth + 10)
        .attr("y", d => y(d.name) + y.bandwidth() / 2 + 5)
        .text(d => d.name)
        .merge(labels)
        .transition().duration(600)
        .attr("x", d => x(11 - d.position) + spriteWidth + 10)
        .attr("y", d => y(d.name) + y.bandwidth() / 2 + 5);
      labels.exit().remove();

      // Atualiza os sprites utilizando o nome da equipe
      const sprites = g.selectAll("image.sprite").data(sorted, d => d.name);
      sprites.enter()
        .append("image")
        .attr("class", "sprite")
        .attr("xlink:href", d => `sprites/${d.equipe}.png`)
        .attr("width", spriteWidth)
        .attr("height", spriteHeight)
        .merge(sprites)
        .transition().duration(600)
        .attr("transform", (d, i) => {
          const posX = x(11 - d.position) + 5;
          const posY = y(d.name) + (y.bandwidth() - spriteHeight) / 2;
          return `translate(${posX + spriteWidth/2},${posY + spriteHeight/2}) rotate(90) translate(${-spriteWidth/2},${-spriteHeight/2})`;
        });
      sprites.exit().remove();

      d3.select("h2").text(`F1 Bar Chart Race - Volta ${lapNum + 1}`);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>F1 Bar Chart Race</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 30px;
    }
    .bar {
      fill-opacity: 0.7;
    }
    .label {
      font-size: 14px;
      fill: #111;
    }
    select, button, input[type=range] {
      margin-right: 10px;
      padding: 5px;
      font-size: 14px;
    }
    input[type=range] {
      width: 200px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <h2>F1 Bar Chart Race - 20 Pilotos</h2>

  <label for="yearSelect">Ano:</label>
  <select id="yearSelect">
    <option value="">Selecione um ano</option>
  </select>

  <label for="raceSelect">Corrida:</label>
  <select id="raceSelect" disabled>
    <option value="">Selecione uma corrida</option>
  </select>

  <br><br>
  <button id="playPause">▶️ Play</button>
  <input type="range" id="lapSlider" min="0" max="0" value="0" step="1" disabled>
  <span id="lapDisplay">Volta 1</span>

  <svg width="1200" height="800"></svg>

  <script>
    const svg = d3.select("svg");
    const width = +svg.attr("width");
    const height = +svg.attr("height");
    const margin = { top: 20, right: 200, bottom: 20, left: 20 };
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;
    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
    
    // Atualize a escala para acomodar 20 pilotos:
    const x = d3.scaleLinear().range([0, chartWidth]);
    // Se os pilotos possuem posições de 1 a 20, usaremos 21 - posição para calcular a largura.
    x.domain([0, 20]); 
    const y = d3.scaleBand().range([0, chartHeight]).padding(0.1);

    // Tamanho do sprite
    const spriteWidth = 64;
    const spriteHeight = 40;
    
    const yearSelect = document.getElementById("yearSelect");
    const raceSelect = document.getElementById("raceSelect");
    const playPauseBtn = document.getElementById("playPause");
    const lapSlider = document.getElementById("lapSlider");
    const lapDisplay = document.getElementById("lapDisplay");

    let currentLap = 0;
    let intervalId = null;
    let isPlaying = false;

    const cores_equipes = {
      red_bull: "#181740",
      mercedez: "#3D3E40",
      ferrari: "#D90707",
      alpine: "#0090FF",
      hass: "#BF0A2B",
      aston_martin: "#048C5A",
      mclaren: "#F28D35",
      sauber: "#05A61D",
      willians: "#113A8C",
      toro_roso: "#F2F2F2"
    };

    const mockRacesByYear = {
      "2022": ["Bahrain GP", "Monaco GP", "Brazil GP"],
      "2023": ["Bahrain GP", "Miami GP", "Japan GP"],
      "2024": ["Australia GP", "Canada GP", "Italy GP"]
    };

    // Array inicial com os 20 pilotos e suas equipes
    const initialDrivers = [
      { name: "Max Verstappen", position: 1, equipe: "red_bull" },
      { name: "Lewis Hamilton", position: 2, equipe: "mercedez" },
      { name: "Charles Leclerc", position: 3, equipe: "ferrari" },
      { name: "Lando Norris", position: 4, equipe: "mclaren" },
      { name: "Sergio Perez", position: 5, equipe: "red_bull" },
      { name: "Carlos Sainz", position: 6, equipe: "ferrari" },
      { name: "Fernando Alonso", position: 7, equipe: "alpine" },
      { name: "Sebastian Vettel", position: 8, equipe: "aston_martin" },
      { name: "Daniel Ricciardo", position: 9, equipe: "mclaren" },
      { name: "Esteban Ocon", position: 10, equipe: "alpine" },
      { name: "Lance Stroll", position: 11, equipe: "aston_martin" },
      { name: "Pierre Gasly", position: 12, equipe: "willians" },
      { name: "Yuki Tsunoda", position: 13, equipe: "toro_roso" },
      { name: "Valtteri Bottas", position: 14, equipe: "mercedez" },
      { name: "Kevin Magnussen", position: 15, equipe: "hass" },
      { name: "Mick Schumacher", position: 16, equipe: "hass" },
      { name: "Nicholas Latifi", position: 17, equipe: "willians" },
      { name: "Alexander Albon", position: 18, equipe: "toro_roso" },
      { name: "Robert Kubica", position: 19, equipe: "sauber" },
      { name: "Guanyu Zhou", position: 20, equipe: "sauber" }
    ];

    const numberOfLaps = 20;
    const mockLaps = [];

    // Adiciona a volta inicial
    mockLaps.push(JSON.parse(JSON.stringify(initialDrivers)));

    // Função para simular algumas ultrapassagens
    function simulateOvertakes(drivers) {
      // Define quantas trocas ocorrerão nesta volta (por exemplo, de 1 a 5 swaps)
      const numSwaps = Math.floor(Math.random() * 5) + 1;
      for (let i = 0; i < numSwaps; i++) {
        // Escolhe aleatoriamente um índice que não seja o primeiro (o líder não pode ultrapassar ninguém)
        const idx = Math.floor(Math.random() * (drivers.length - 1)) + 1;
        // Simula uma ultrapassagem trocando o piloto com o que está imediatamente à frente
        [drivers[idx - 1], drivers[idx]] = [drivers[idx], drivers[idx - 1]];
      }
      // Atualiza a propriedade "position" conforme a nova ordem
      drivers.forEach((driver, index) => {
        driver.position = index + 1;
      });
      return drivers;
    }

    // Gera as voltas restantes
    for (let lap = 1; lap < numberOfLaps; lap++) {
      // Clona a volta anterior para basear a nova simulação
      const previousLap = JSON.parse(JSON.stringify(mockLaps[lap - 1]));
      const newLap = simulateOvertakes(previousLap);
      mockLaps.push(newLap);
    }

    // Agora utilizamos o array "mockLaps" como "laps"
    let laps = mockLaps;

    const availableYears = ["2022", "2023", "2024"];
    availableYears.forEach(year => {
      const option = document.createElement("option");
      option.value = year;
      option.textContent = year;
      yearSelect.appendChild(option);
    });

    yearSelect.addEventListener("change", () => {
      const selectedYear = yearSelect.value;
      raceSelect.innerHTML = '<option value="">Selecione uma corrida</option>';
      raceSelect.disabled = true;

      if (selectedYear && mockRacesByYear[selectedYear]) {
        mockRacesByYear[selectedYear].forEach(race => {
          const opt = document.createElement("option");
          opt.value = race;
          opt.textContent = race;
          raceSelect.appendChild(opt);
        });
        raceSelect.disabled = false;
      }

      stopPlayback();
    });

    raceSelect.addEventListener("change", () => {
      const raceChosen = raceSelect.value;
      if (raceChosen) {
        currentLap = 0;
        renderLap(laps[currentLap], currentLap);
        updateUI();
      }
      stopPlayback();
    });

    playPauseBtn.addEventListener("click", () => {
      if (isPlaying) {
        stopPlayback();
      } else {
        isPlaying = true;
        playPauseBtn.textContent = "⏸️ Pause";
        intervalId = setInterval(() => {
          if (currentLap < laps.length - 1) {
            currentLap++;
            lapSlider.value = currentLap;
            renderLap(laps[currentLap], currentLap);
            updateUI();
          } else {
            stopPlayback();
          }
        }, 1500);
      }
    });

    lapSlider.addEventListener("input", () => {
      currentLap = parseInt(lapSlider.value);
      renderLap(laps[currentLap], currentLap);
      updateUI();
      stopPlayback();
    });

    function stopPlayback() {
      clearInterval(intervalId);
      isPlaying = false;
      playPauseBtn.textContent = "▶️ Play";
    }

    function updateUI() {
      lapSlider.max = laps.length - 1;
      lapSlider.disabled = false;
      lapSlider.value = currentLap;
      lapDisplay.textContent = `Volta ${currentLap + 1}`;
    }

    // Define a cor de fundo do SVG
    d3.select("svg").style("background-color", "#A39B9B");

    function renderLap(data, lapNum) {
      // Ordena todos os 20 pilotos conforme a posição
      const sorted = [...data].sort((a, b) => a.position - b.position);
      
      // Atualiza o domínio do eixo y com todos os nomes
      y.domain(sorted.map(d => d.name));
      
      // Atualiza as barras usando 21 - posição para que o líder tenha a maior largura
      const bars = g.selectAll(".bar").data(sorted, d => d.name);
      bars.enter()
        .append("rect")
        .attr("class", "bar")
        .attr("x", 0)
        .attr("height", y.bandwidth())
        .attr("y", d => y(d.name))
        .attr("width", d => x(21 - d.position))
        .attr("fill", d => cores_equipes[d.equipe] || "#ccc")
        .merge(bars)
        .transition().duration(600)
        .attr("y", d => y(d.name))
        .attr("width", d => x(21 - d.position));
      bars.exit().remove();

      // Atualiza os labels
      const labels = g.selectAll(".label").data(sorted, d => d.name);
      labels.enter()
        .append("text")
        .attr("class", "label")
        .attr("x", d => x(21 - d.position) + spriteWidth + 10)
        .attr("y", d => y(d.name) + y.bandwidth() / 2 + 5)
        .text(d => d.name)
        .merge(labels)
        .transition().duration(600)
        .attr("x", d => x(21 - d.position) + spriteWidth + 10)
        .attr("y", d => y(d.name) + y.bandwidth() / 2 + 5);
      labels.exit().remove();

      // Atualiza os sprites utilizando o nome da equipe
      const sprites = g.selectAll("image.sprite").data(sorted, d => d.name);
      sprites.enter()
        .append("image")
        .attr("class", "sprite")
        .attr("xlink:href", d => `sprites/${d.equipe}.png`)
        .attr("width", spriteWidth)
        .attr("height", spriteHeight)
        .merge(sprites)
        .transition().duration(600)
        .attr("transform", (d, i) => {
          const posX = x(21 - d.position) + 5;
          const posY = y(d.name) + (y.bandwidth() - spriteHeight) / 2;
          return `translate(${posX + spriteWidth/2},${posY + spriteHeight/2}) rotate(90) translate(${-spriteWidth/2},${-spriteHeight/2})`;
        });
      sprites.exit().remove();

      d3.select("h2").text(`F1 Bar Chart Race - Volta ${lapNum + 1}`);
    }
  </script>
</body>
</html>
